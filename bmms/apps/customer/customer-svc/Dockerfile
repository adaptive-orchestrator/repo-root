# ==============================
# üß± Stage 1 ‚Äî Build
# ==============================
FROM node:22-alpine AS builder

# T·∫°o th∆∞ m·ª•c l√†m vi·ªác
WORKDIR /usr/src/app

# Copy package files
COPY package*.json ./

# C√†i ƒë·∫∑t dependencies
RUN npm install

# Copy to√†n b·ªô source code v√†o container
COPY . .

# Build NestJS (output s·∫Ω v√†o ./dist)
RUN npm run build

# ==============================
# üöÄ Stage 2 ‚Äî Production
# ==============================
FROM node:22-alpine

WORKDIR /usr/src/app

# Copy ch·ªâ nh·ªØng g√¨ c·∫ßn cho runtime
COPY --from=builder /usr/src/app/dist ./dist
COPY package*.json ./

# C√†i dependencies production (nhanh h∆°n, nh·∫π h∆°n)
RUN npm install --omit=dev

# ƒê·∫∑t bi·∫øn m√¥i tr∆∞·ªùng
ENV NODE_ENV=production

# Expose port (thay b·∫±ng port service b·∫°n mu·ªën)
EXPOSE 9092

# Command start service
CMD ["node", "dist/main.js"]
