# ğŸ¨ Architecture Diagrams - Freemium + Billing Strategy

## 1. Billing Strategy Pattern - Class Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    <<interface>>                                 â”‚
â”‚                  IBillingStrategy                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + calculateAmount(params): Promise<BillingResult>               â”‚
â”‚ + canHandle(businessModel: string): boolean                     â”‚
â”‚ + getStrategyName(): string                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Onetime        â”‚ â”‚   Recurring      â”‚ â”‚   Freemium       â”‚
â”‚   Billing        â”‚ â”‚   Billing        â”‚ â”‚   Billing        â”‚
â”‚   Strategy       â”‚ â”‚   Strategy       â”‚ â”‚   Strategy       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ canHandle:       â”‚ â”‚ canHandle:       â”‚ â”‚ canHandle:       â”‚
â”‚  'retail'        â”‚ â”‚  'subscription'  â”‚ â”‚  'freemium'      â”‚
â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚
â”‚ calculate:       â”‚ â”‚ calculate:       â”‚ â”‚ calculate:       â”‚
â”‚  subtotal + tax  â”‚ â”‚  plan + tax +    â”‚ â”‚  base(0) +       â”‚
â”‚                  â”‚ â”‚  nextBillingDate â”‚ â”‚  addons + tax    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Strategy Selection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Request arrives at BillingService                   â”‚
â”‚  createWithStrategy(dto, businessModel?, addons?)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           BillingStrategyService.getStrategy()                   â”‚
â”‚                                                                  â”‚
â”‚  Priority 1: Check metadata.businessModel                       â”‚
â”‚  â”œâ”€â†’ If exists â†’ Find strategy.canHandle(businessModel)        â”‚
â”‚  â””â”€â†’ If found â†’ Return strategy âœ…                              â”‚
â”‚                                                                  â”‚
â”‚  Priority 2: Check ENV var BILLING_MODE                         â”‚
â”‚  â”œâ”€â†’ Read process.env.BILLING_MODE                             â”‚
â”‚  â””â”€â†’ Find matching strategy âœ…                                  â”‚
â”‚                                                                  â”‚
â”‚  Fallback: Use default (OnetimeBillingStrategy)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Strategy.calculateAmount()                      â”‚
â”‚                                                                  â”‚
â”‚  Input: items, addons, metadata                                 â”‚
â”‚  Output: {subtotal, tax, total, billingMode, nextBillingDate}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Create Invoice with calculated amounts              â”‚
â”‚  invoice.metadata = {billingMode, businessModel, addonCharges}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Freemium User Journey - Sequence Diagram

```
User           SubscriptionSvc      BillingService       PaymentService
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚ 1. Sign up FREE   â”‚                    â”‚                     â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                     â”‚
 â”‚  subscription_id  â”‚                    â”‚                     â”‚
 â”‚  (is_free_tier)   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚ 2. Browse addons  â”‚                    â”‚                     â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                     â”‚
 â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                     â”‚
 â”‚  List of addons   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚ 3. Purchase 2     â”‚                    â”‚                     â”‚
 â”‚    addons         â”‚                    â”‚                     â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                     â”‚
 â”‚                   â”‚ Create user_addons â”‚                     â”‚
 â”‚                   â”‚ records            â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚ Emit ADDON_        â”‚                     â”‚
 â”‚                   â”‚ PURCHASED event    â”‚                     â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
 â”‚                   â”‚                    â”‚ FreemiumBilling     â”‚
 â”‚                   â”‚                    â”‚ Strategy selected   â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚ Calculate:          â”‚
 â”‚                   â”‚                    â”‚ base(0) + addons    â”‚
 â”‚                   â”‚                    â”‚ = 150k + tax 15k    â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚ Create invoice      â”‚
 â”‚                   â”‚                    â”‚ (165k VND)          â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚ Emit INVOICE_       â”‚
 â”‚                   â”‚                    â”‚ CREATED             â”‚
 â”‚                   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚ Process
 â”‚                   â”‚                    â”‚                     â”‚ payment
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                   â”‚                    â”‚  PAYMENT_SUCCESS    â”‚
 â”‚                   â”‚                    â”‚                     â”‚
 â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
 â”‚  Features         â”‚  Invoice paid      â”‚                     â”‚
 â”‚  unlocked!        â”‚                    â”‚                     â”‚
 â”‚                   â”‚                    â”‚                     â”‚
```

---

## 4. Multi-Model Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RETAIL MODEL                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User                                                           â”‚
â”‚   â”‚                                                             â”‚
â”‚   â””â”€â†’ Buy product (50,000 VND)                                â”‚
â”‚         â”‚                                                       â”‚
â”‚         â””â”€â†’ OnetimeBillingStrategy                            â”‚
â”‚               â”‚                                                 â”‚
â”‚               â””â”€â†’ Invoice: 50k + tax = 55k                    â”‚
â”‚                     billingMode: 'onetime'                     â”‚
â”‚                     nextBillingDate: null                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUBSCRIPTION MODEL                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User                                                           â”‚
â”‚   â”‚                                                             â”‚
â”‚   â””â”€â†’ Subscribe Plan 1 (99,000 VND/month)                     â”‚
â”‚         â”‚                                                       â”‚
â”‚         â””â”€â†’ RecurringBillingStrategy                          â”‚
â”‚               â”‚                                                 â”‚
â”‚               â””â”€â†’ Invoice: 99k + tax = 108.9k                 â”‚
â”‚                     billingMode: 'recurring'                   â”‚
â”‚                     nextBillingDate: +1 month                  â”‚
â”‚                                                                 â”‚
â”‚   [ Auto-renewal every month ]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FREEMIUM MODEL                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User                                                           â”‚
â”‚   â”‚                                                             â”‚
â”‚   â”œâ”€â†’ Sign up FREE                                            â”‚
â”‚   â”‚     â””â”€â†’ NO invoice (base plan is free)                    â”‚
â”‚   â”‚                                                             â”‚
â”‚   â””â”€â†’ Purchase add-ons:                                       â”‚
â”‚         â”œâ”€ Extra Storage: 50,000 VND                          â”‚
â”‚         â””â”€ AI Assistant: 100,000 VND                          â”‚
â”‚           â”‚                                                     â”‚
â”‚           â””â”€â†’ FreemiumBillingStrategy                         â”‚
â”‚                 â”‚                                               â”‚
â”‚                 â””â”€â†’ Invoice: 150k + tax = 165k                â”‚
â”‚                       billingMode: 'addon_only'                â”‚
â”‚                       addonCharges: [50k, 100k]                â”‚
â”‚                       nextBillingDate: +1 month (per addon)    â”‚
â”‚                                                                 â”‚
â”‚   [ Auto-renewal for each addon monthly ]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Database Entity Relationship

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   subscriptions  â”‚         â”‚      addons      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚         â”‚ id (PK)          â”‚
â”‚ customer_id      â”‚         â”‚ addon_key        â”‚
â”‚ plan_id          â”‚         â”‚ name             â”‚
â”‚ status           â”‚         â”‚ description      â”‚
â”‚ is_free_tier â—„â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”   â”‚ price            â”‚
â”‚ ...              â”‚     â”‚   â”‚ billing_period   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚ is_active        â”‚
         â”‚               â”‚   â”‚ features (JSON)  â”‚
         â”‚               â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚            â”‚
         â”‚               â”‚            â”‚
         â”‚               â”‚            â”‚
         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚      â”‚     user_addons            â”‚
         â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚      â”‚ id (PK)                   â”‚
         â””â”€â”€â”€â”€â”€>â”‚ subscription_id (FK)      â”‚
                â”‚ addon_id (FK) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ customer_id               â”‚
                â”‚ price                     â”‚
                â”‚ status                    â”‚
                â”‚ purchased_at              â”‚
                â”‚ expires_at                â”‚
                â”‚ next_billing_date         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚       invoices            â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚ id (PK)                   â”‚
                â”‚ invoice_number            â”‚
                â”‚ customer_id               â”‚
                â”‚ order_id                  â”‚
                â”‚ subscription_id           â”‚
                â”‚ subtotal                  â”‚
                â”‚ tax                       â”‚
                â”‚ total_amount              â”‚
                â”‚ status                    â”‚
                â”‚ metadata (JSON) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ {billingMode,
                â”‚   - billingMode           â”‚    businessModel,
                â”‚   - businessModel         â”‚    addonCharges,
                â”‚   - addonCharges[]        â”‚    nextBillingDate}
                â”‚   - nextBillingDate       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Service Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React)                          â”‚
â”‚  /products, /subscriptions, /freemium-plans, /addons            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Gateway (port 3099)                        â”‚
â”‚  Route requests to appropriate services                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                 â”‚
        â–¼                   â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrderService â”‚  â”‚ Subscription   â”‚  â”‚  BillingService  â”‚
â”‚ (port 3011)  â”‚  â”‚ Service        â”‚  â”‚  (port 3003)     â”‚
â”‚              â”‚  â”‚ (port 3012)    â”‚  â”‚                  â”‚
â”‚ â€¢ Retail     â”‚  â”‚                â”‚  â”‚ â€¢ Strategy       â”‚
â”‚   orders     â”‚  â”‚ â€¢ Subscription â”‚  â”‚   Pattern        â”‚
â”‚              â”‚  â”‚   management   â”‚  â”‚ â€¢ Onetime        â”‚
â”‚              â”‚  â”‚ â€¢ Freemium     â”‚  â”‚ â€¢ Recurring      â”‚
â”‚              â”‚  â”‚   signup       â”‚  â”‚ â€¢ Freemium       â”‚
â”‚              â”‚  â”‚ â€¢ Add-on       â”‚  â”‚                  â”‚
â”‚              â”‚  â”‚   purchases    â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Kafka     â”‚
                    â”‚   Events     â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ â€¢ ORDER_     â”‚
                    â”‚   CREATED    â”‚
                    â”‚ â€¢ SUBSCRIPTIONâ”‚
                    â”‚   _CREATED   â”‚
                    â”‚ â€¢ ADDON_     â”‚
                    â”‚   PURCHASED  â”‚
                    â”‚ â€¢ INVOICE_   â”‚
                    â”‚   CREATED    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ENV Configuration Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service       â”‚  Retail      â”‚ Subscription  â”‚  Freemium    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BillingService  â”‚ BILLING_MODE â”‚ BILLING_MODE  â”‚ BILLING_MODE â”‚
â”‚                 â”‚ =onetime     â”‚ =recurring    â”‚ =freemium    â”‚
â”‚                 â”‚              â”‚               â”‚              â”‚
â”‚                 â”‚ TAX_RATE     â”‚ TAX_RATE      â”‚ TAX_RATE     â”‚
â”‚                 â”‚ =0.1         â”‚ =0.1          â”‚ =0.1         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OrderService    â”‚ âœ… Running   â”‚ â¬‡ï¸ Stopped    â”‚ â¬‡ï¸ Stopped   â”‚
â”‚                 â”‚ replicas: 1  â”‚ replicas: 0   â”‚ replicas: 0  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Subscription    â”‚ â¬‡ï¸ Stopped   â”‚ âœ… Running    â”‚ âœ… Running   â”‚
â”‚ Service         â”‚ replicas: 0  â”‚ replicas: 1   â”‚ replicas: 1  â”‚
â”‚                 â”‚              â”‚               â”‚              â”‚
â”‚                 â”‚              â”‚ FREE_TIER     â”‚ FREE_TIER    â”‚
â”‚                 â”‚              â”‚ =false        â”‚ =true        â”‚
â”‚                 â”‚              â”‚               â”‚              â”‚
â”‚                 â”‚              â”‚ ADDON_ENABLED â”‚ ADDON_ENABLEDâ”‚
â”‚                 â”‚              â”‚ =false        â”‚ =true        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Billing Calculation Flow

```
Input: Order/Subscription + Add-ons
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BillingStrategyService.calculate() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚            â”‚
    â–¼                 â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retail? â”‚    â”‚Subscriptionâ”‚  â”‚Freemium? â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                â”‚               â”‚
     â–¼                â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate  â”‚  â”‚ Calculate â”‚  â”‚ Calculate  â”‚
â”‚ subtotal   â”‚  â”‚ plan_priceâ”‚  â”‚ base (0)   â”‚
â”‚            â”‚  â”‚           â”‚  â”‚ + addons   â”‚
â”‚ items.sum()â”‚  â”‚ plan.priceâ”‚  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Add TAX (10%) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Apply Discountâ”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Calculate Total       â”‚
          â”‚ = subtotal + tax      â”‚
          â”‚   - discount          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Return BillingResult:     â”‚
      â”‚ {                         â”‚
      â”‚   subtotal,               â”‚
      â”‚   tax,                    â”‚
      â”‚   discount,               â”‚
      â”‚   totalAmount,            â”‚
      â”‚   billingMode,            â”‚
      â”‚   nextBillingDate?,       â”‚
      â”‚   addonCharges?           â”‚
      â”‚ }                         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Legend

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Box  â”‚  = Component/Service
â””â”€â”€â”€â”€â”€â”€â”˜

  â”‚
  â–¼      = Flow direction

â—„â”€â”€â”€â”€â”€â”€  = Reference/Relationship

â”Œâ”€â”€â”€â”
â”‚PK â”‚    = Primary Key
â””â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”
â”‚FK â”‚    = Foreign Key
â””â”€â”€â”€â”˜

âœ…       = Running/Active
â¬‡ï¸       = Stopped/Inactive
ğŸ”„       = Auto-renewal
```

---

**Note:** CÃ¡c diagrams nÃ y Ä‘Æ°á»£c táº¡o báº±ng ASCII art Ä‘á»ƒ dá»… Ä‘á»c trong terminal/markdown viewer.
