# ========================
# Stage 1 - Build
# ========================
FROM node:22-alpine AS builder
WORKDIR /usr/bmms
COPY package*.json ./
RUN npm install
COPY ./apps ./apps/
COPY *.json ./
COPY ./libs ./libs/
COPY .env ./
RUN npm run build 

# ========================
# Stage 2 - Production
# ========================
FROM node:22-alpine
WORKDIR /usr/bmms
COPY --from=builder /usr/bmms/dist/apps/product/catalogue-svc ./dist/apps/product/catalogue-svc
COPY --from=builder /usr/bmms/apps/product/catalogue-svc/src/proto ./dist/apps/product/catalogue-svc/src/proto
COPY --from=builder /usr/bmms/dist/libs ./dist/libs/
COPY .env ./
COPY package*.json ./
ENV NODE_ENV=production
RUN npm install --omit=dev

CMD ["node", "dist/apps/product/catalogue-svc/src/main.js"]